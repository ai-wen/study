
# [SIM卡型U盾](https://www.asiainfo-sec.com/contents/2944/12456.html)
# [5G超级SIM](https://zhuanlan.zhihu.com/p/171818124)

# [TEE+SE 是移动安全的终极解决方案吗？ ](https://www.sohu.com/a/167500361_279109)
## 一、基于安全元件(Secure Element)密钥保护技术
PC端 第一代U盾,第二代U盾
在传统的PC上，密钥通常都直接存储在硬盘上。随着移动支付的普及，这种密钥裸奔的方式逐渐的暴露出了各种问题，导致支付等应用屡屡出现问题，根本原因是：密钥需要存储在可信的安全的环境中。由于操作系统的复杂性，导致这杂种假设根本不成立，所以产生了第一代U盾产品，也就是国内比较早的安全元件的概念产品，既然操作系统很复杂，可以找个低复杂度的系统来完成运算，保证密钥不出U盾，从而保证了密钥的安全。但随着时间的推移，发现运行在Slave状态下的U盾非常容易受到欺骗，病毒程序可以随意欺骗U盾完成密码运算，所以，一代U盾就自然地过渡到了可显示、可确认的第二代U盾，即用户必须通过不能被操作系统软件控制的显示器和物理按键来完成密码计算，从而确保密码设备正确接受了真实的用户意愿。安全元件的安全不仅仅在于隔离，还需要考虑正确执行真实的用户意图问题。

我们需要更强的安全假设，来服务于需要更高安全级别的系统信任根。将密钥存储到简单安全元件里，解决了复杂的软件不可控，容易有漏洞从而关键信息容易被偷窃盗用的安全风险，安全元件自身还需要面对各种各样的其他攻击。因为软件系统简单，硬件元器件相对较少，故而容易建立物理防护和实施安全保障，从而提高安全元件的安全强度，从而可以服务于安全假设更强的安全系统。

随着移动互联网的发展，在移动终端上使用额外的安全元件会导致成本的提高，外置安全元件时会导致用户体验下降。
我们迫切需要一种更为便捷易用和价格低廉的密钥保护技术。TEE的概念，正逐渐地重视起来。

## 二、基于可信执行环境(TEE)的密钥保护技术
移动端 REE TEE
为了解决纯硬件安全防护在移动终端上部署不便的弊端，开放移动终端组织提出了可信执行环境 (Trusted Execution Environment，简称TEE)的概念和方案，即纯软件的环境和安全元件之间的折中方案。TEE旨在构建一个资源丰富的执行环境，从设备自身来提高安全性，能够进行各种各样的应用扩展，为用户使用和服务提供商的开发提供了更大的空间与自由度。
TEE总体层次架构图如下所示：![](https://github.com/ai-wen/study/blob/master/TEE.png)
普通执行环境(Rich Execution Environment，简称REE)包括运行在通用的嵌入式处理器上的普通操作系统(Rich Operating System，简称Rich OS)及其上的客户端应用程序。尽管在REE中采取了很多诸如设备访问控制、设备数据加密机制、应用运行时的隔离机制、基于权限的访问控制等安全措施，但仍无法保证敏感数据的安全性。TEE是运行于普通操作系统之外的独立运行环境，其向一般操作系统提供安全服务并且与Rich OS隔离。Rich OS及其上的应用程序无法直接访问TEE的硬件和软件资源。

TEE的目标是在移动设备的主芯片中建立一个可信执行环境，它是硬件可信的。TEE为可信应用(通过TEE授权的、可信的软件)提供可信赖的运行环境，再通过对机密性、完整性的保护和数据访问权限的控制，确保端到端的安全。可信执行环境与终端原有操作系统并行，通过安全的API与原有系统进行交互。

TEE提供了介于典型操作系统和安全元件(SE)之间的一种适度安全性。它提供了一个比Rich OS更高安全等级的运行环境，但无法提供硬件隔离级别的安全的密钥存储和密钥运行环境由于TEE中的密码单元仍旧通过API供REE调用，简单采用TEE编制的密码模块仍旧会工作在被动被调用的Slave模式下，在Slave模式下的SE的安全弱点它也都有。人们也正在设计更好的工作方法，确保具备更好的安全性。

## 三、基于TEE+SE的密钥保护技术
在认识到TEE存在的这些问题后，金融界发力、厂商配合，华为等公司推出了板载SE的手机。尤其随着生物识别技术的爆发式发展， FIDO等协议的推广，板载SE的支撑也逐步成了目前移动终端的标配。

TEE+SE的方案整体来说比较复杂，原理上也会觉得有冗余，业界一般希望通过TEE来构建可信的显示，打通领会真实用户意图的通道，SE来构建可信的安全的密钥存储和密钥运算环境，试图终结移动安全方面针对密钥安全问题的讨论。然而，用户又如何知道和区分TEE和REE呢，用户又如何有效地控制SE呢。当病毒或黑客的能力足够强大的时候，我们如何保障SE不被非法地调用，手机用户不会被病毒和黑客欺骗就成为目前的重要问题。

## 四、基于CloudSE的密钥保护技术
基于安全元件SE、基于可信执行环境TEE和基于TEE+SE的身份认证方案中，密钥及关键数据都是在移动终端中进行保护，不但面临着移动终端上各种恶意软件的威胁，同时也存在着丢失后难以恢复等问题。在SE为基础的系统中，SE的安全是信任的锚点，但是SE真的安全吗?SE在焊接到手机板卡后，他已经没有能力来抵御未来存在的可能的攻击。

CloudSE将密钥及关键数据在云端进行保护，不再依赖于移动终端自身的防护能力，可以提供集中式的安全防护，同时方便用户进行恢复。同时，其不再依赖于安全元件SE的安全存储和可信执行环境TEE，由云端的服务器模拟完成SE功能，从软件层面摆脱了硬件的限制，为安全支付领域的应用扩展提供了便利条件。CloudSE方案不依赖特殊的安全硬件，应用厂商可以独立完成业务流程，脱离了传统的SE芯片载体的限制，各类应用的密钥被存储在云端服务器，在云端调用相应密钥进行身份认证，大大降低了移动终端受到侵害后导致关键数据泄露的风险。

云端成为整个方案的核心部位，虽然可以对关键数据进行更高强度的保护，但是一旦被敌手攻破，就会导致大量用户的关键数据被窃取，造成巨大的经济损失。况且，作为云端，未来数据集中、计算集中后，最大的问题就是如何得到用户信任的问题。

## 五、基于移动KEY的密钥保护技术
上述四种身份认证方案将密钥等关键信息存储在单一节点(移动终端或者云端)，这使得该存储节点成为整个系统的瓶颈：一旦该节点被攻破，移动智能终端将会面临严重的安全威胁。为了解决密钥在单一节点存储带来的安全隐患，中国科学院数据与通信保护研究教育中心(DCS中心)提出了基于密钥拆分技术的移动KEY密钥保护方案：将密钥将拆分成两个部分，分别存储在服务端和移动终端，使用时进行协作计算，密钥不会在任何一方完整出现，即参与运算的任何一方都不会拿到完整的密钥。同时，存储在移动终端的部分密钥也采用白盒密码的相关技术分散在终端内，并于设备绑定，永远不合成出现。DCS中心移动KEY的密钥保护方案通过了国家密码管理局的安全性审查，并取得了商用密码产品型号证书，命名为SHM1703智能移动终端安全密码模块。
此种方案的核心思想是对密钥进行了拆分和分别的存储，云端和终端有了一定的安全制衡关系，只有双方协作才能完成密码运算功能，参与运算的任何一方不能完整掌握密钥。在不需要可信显示的应用场景，这个方案的安全级别可以归约到安全元件的安全级别。在最坏的攻击场景下，攻击者可以有条件地使用密钥，但不能完全掌握密钥。

移动KEY的安全特点主要有：
1. 是国内首款达到GM/T 0028-2014 《密码模块安全技术要求》安全等级第二级的软件密码模块，可以支持一般的金融交易和网上政务商务应用。
2. 利用移动终端中的硬件信息构造本地部分密钥的部分密钥，从而实现密钥与设备的绑定。通过硬件信息绑定确保即使全部内存和软件全部拷贝到其他设备也无法重现该设备中的部分密钥。
3. 在部分密钥中除硬件信息外，剩下的部分密钥继续采用拆分算法和白盒密码的手段，同时确保部分密钥在计算过程中永远不合成，来提高包括侧信道攻击在内的各种攻击手段的门槛。直接在拆分状态下进行计算确保了一般的黑客无法直接发现设备中部分密钥。
4. 由于移动KEY采用软件实现，其集成的监控功能只有用户许可的APP才能使用密码计算，从而确保病毒和其他非法软件无法调用移动KEY的密码功能。
5. 移动KEY的关键部分采用汇编和C编码，整体还采用了常规的代码混淆技术，确保一般软件分析难以奏效。
6. 通过预设的安全图片和安全提示，确保用户只在移动KEY正确运行时用户输入PIN码、验证指纹和查看签名信息，确保移动 KEY仅执行用户授意的数字签名和密码计算。
结束语尽管移动KEY具备很多安全优势和应用便利，但仍旧有许多可以改进的空间，绝对安全的设备是不存在的。比如，将白盒密码运算部分移植到TEE就可以更加增强移动KEY的安全性。我们热切期盼新一代移动KEY尽快诞生，为进一步推进自主可控密码在金融等重要领域的深入广泛应用做出更大的贡献。














# [从 Secure Element 到 Android KeyStore](https://www.cnblogs.com/xinzhao/p/9319419.html)

## SE（Secure Element）
1. 按照Global Platform的定义：安全单元提供私密信息的安全存储、重要程序的安全执行等功能。其内部组件包含有：CPU、RAM、ROM、加密引擎、传感器等
2. 外在表现上SE是一块物理上独立的芯片卡。从外在表现上可以分为三种：
    UICC 通用集成电路卡，由电信运营商发布和使用。就是大家购买手机号时的手机SIM卡；
    Embedded SE 虽然也是独立的芯片，但普通用户看不到，由手机制造厂商在手机出厂前集成在手机内部；
    Micro SD 以SD存储卡的形式存在，通过插入SD卡槽集成到手机上。由独立的SE制造商制造和销售；

SE物理上独立，采用安全协议与外部通讯。具有自己独立的执行环境和安全存储，软件和硬件上防篡改。
软件通过签名等方式防篡改。
硬件防篡改，简单说就是物理拆改SE，它会自毁。最简单的硬件防篡改的例子，大家可以参考大家给自己车安装车牌时所使用的单向螺丝和防盗帽。    

SE固若金汤，但保存在其中的数据和程序需要有更新机制，这通过TSM（Trusted Service Manager）来实现，以保证安全。
SE不年轻了从19世纪70年代就开始发展，但它十分安全，是目前手机上最安全的技术措施。

## NFC（Near-field Communication）
近场通信是一种短距高频的无线电技术，在13.56MHz频率运行于20厘米距离内，由非接触式射频识别（RFID，公交卡、校园一卡通、门禁卡等都采用RFID技术实现）演变而来，由飞利浦、诺基亚和索尼于2004年共同研制开发。目前已成为ISO/IEC IS 18092国际标准、EMCA-340标准与ETSI TS 102 190标准。

NFC设备有三种工作模式：

卡模拟模式（Card emulation mode）：这个模式其实就是相当于一张采用RFID技术的IC卡。可以替代现在大量的IC卡（包括信用卡）场合商场刷卡、IPASS、门禁管制、车票、门票等等。
读卡器模式（Reader/Writer mode）：作为非接触读卡器使用，可用来实现给公交卡充值等功能。
点对点模式（P2P mode）：这个模式和红外线差不多，可用于数据交换，只是传输距离较短，传输创建速度较快，传输速度也快些，功耗低（蓝牙也类似）。将两个具备NFC功能的设备链接，能实现数据点对点传输，如下载音乐、交换图片或者同步设备地址薄。
三种工作模式中，卡模拟模式用途最为广泛，可将用平时使用的各种卡通过手机模拟实现，从此出门不再带卡。此种方式下，NFC芯片通过非接触读卡器的RF域来供电，即便是手机没电也可以工作。

NFC设备若要进行卡片模拟（Card Emulation）相关应用，则必须内置安全单元（Security Element, SE）以保存重要隐私数据。可以说NFC给SE插上了翅膀，在NFC广泛应用的今天，SE如此的重要，成为电信运营商（移动、联通、电信等）、手机厂商（华为、小米等）、操作系统厂商（谷歌、苹果等）的兵家必争之地。

### HCE（Host Card Emulation）
因为不涉及硬件制造，在SE的竞争过程中，操作系统厂商相对弱势，确切的说是谷歌弱势，因为苹果既是操作系统厂商，也是手机厂商。
早期Goole Pay是基于SE实现的，但由于在SE生态环境中弱势的竞争地位，导致Google Pay适配的机型少，难以发展。从Android 4.4开始，谷歌独辟蹊径在Android系统中提供了HCE服务，用来绕过SE直接控制NFC Controller。
HCE不在依赖设备上的SE模块，只要有NFC芯片就可以实现支付等功能，但其实是无奈之举。方便是方便了，有两个主要缺点：一个是安全性有所降低，虽然可以使用白盒密码、服务端token校验等一系列手段来提升安全性，但相比SE，安全性降低到依赖Android OS，只要OS被攻破，HCE就无法保证安全；一个是费电，NFC Controller + SE的方案，可以在手机无电的情况下，使用NFC读卡器的电磁信号供电。而HCE则必须在手机供电，OS正常工作甚至还要联网的情况下才能使用。
相对的，因为对设备有这强的控制力，苹果的Apple Pay是基于SE实现的，更安全一些。

## TEE（Trusted Execution Environment）
SE千般好，除了慢。硬件隔离，独立的计算和存储资源，意味着SE的计算性能差、跟主机的数据传输速度也慢，这限制了SE的应用场景。与此同时，移动互联网发展迅速，迫切需要一个更好的安全生态。因此TEE应运而生。

TEE是一个硬件安全执行环境，通常跟平时使用的Rich OS（Android等）共用同一个主处理器（CPU），提供了代码和数据的安全防护、外置设备的安全访问等功能。TEE具有自己的TEE OS，可以安装和卸载执行其中的安全应用TA（TEE Application）。跟SE相比，是一个相对不那么安全，但运行速度更快、功能更丰富的安全环境。为所有支持TEE的手机，提供了操作系统之外的安全方案。
TEE的内部API和外部API都由Global Platform定义和发布。TEE得到了业界广泛的支持，比如ARM在2006年就发布了ARM处理器下的TEE方案TrustZone，AMD、Intel、华为海思等，也有自己的TEE方案。
TEE广泛应用在支付、身份认证、内容保护等领域。举例来讲，视频厂商往往需要DRM（Digital rights management）系统来保护版权内容能够顺利得在用户设备上播放，而不被泄露。TEE天然适合用来完成这种需求，其安全存储的能力可以用来保存解密版权内容所需密钥，这样，TEE Application访问可信的服务端获取已加密的版权视频后，使用安全密钥解密，然后利用安全访问外置设备的能力，锁住显卡和声卡，将解密后的视频送往显卡和声卡播放。整个过程中，不管是加密密钥还是视频内容都没有离开过TEE，保护了版权视频的安全。尤其值得一提的，因其锁定外置设备的能力，想通过录屏来窃取内容，也是不可能的。

|对比项|SE|TEE|REE|
|-|-|-|-|
|安全级别|最高（硬件防篡改）|高（硬件安全方案）|普通|	
|性能|差|高|高|
|是否在主处理器执行|否|是（极个别情况有独立处理器）|是|
|安全的外设访问|不支持|支持|不支持|
|提供硬件证明|一定程度上提供|提供|不提供|	
|软件生态|较差|较好|极好|	

### Android Fingerprint
Android设备的指纹识别，依赖TEE来实现用户指纹认证，要求指纹采集、注册和识别都必须在TEE内部进行，已保证安全。
### Android KeyStore
Android从4.0开始引入了KeyStore，开发者可以使用KeyStore API生成密钥、使用密钥签名、使用密钥加解密、获取密钥的属性信息，但无法将密钥本身从KeyStore中取出。因为密钥不进入应用进程，这大大提高了密钥的安全性。随着Android版本更迭，KeyStore的实现不断进化得更加安全，在有些设备上，不仅密钥不进入应用进程，甚至不进入Android OS只存储在TEE或SE中，接下来我们大概列举下KeyStore的进化。

|Android 版本|	新增的KeyStore能力|
|-|-|
|4.0|	创世版本，密钥使用用户的passcde加密后存储，支持RSA、ECDSA|
|4.1|	增加了使用安全硬件的基础设施，在可能的情况下密钥会被存储到安全硬件中|
|6.0|	增加支持AES、HMAC；增加了密钥绑定用户认证的能力，即可以指定某些密钥，在每一次使用时，必须由用户进行认证（指纹、passcode等）|
|7.0|	强制要求预装7.0系统的设备必须拥有安全硬件并且支持基于安全硬件的KeyStore|
|8.0|	增加了设备证明（Key Attestation）能力，开发者可通过验证Key Attestation的证书链，来确认密钥的确保存在了安全硬件中|









